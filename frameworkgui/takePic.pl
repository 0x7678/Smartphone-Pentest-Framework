#!/usr/bin/perl
use DBI;
use Cwd;

# Read the standard input (sent by the form):
read(STDIN, $FormData, $ENV{'CONTENT_LENGTH'});
# Get the name and value for each form input:
@pairs = split(/&/, $FormData);
# Then for each name/value pair....
foreach $pair (@pairs) {
	# Separate the name and value:
	($name, $value) = split(/=/, $pair);
	# Convert + signs to spaces:
	$value =~ tr/+/ /;
	# Convert hex pairs (%HH) to ASCII characters:
	$value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
	# Store values in a hash called %FORM:
	$FORM{$name} = $value;
}


$agent = $FORM{"agentsDD"};
$delivery = $FORM{"deliveryMethodRB"};
$modemNo = $FORM{"modemNoDD"};
                                                                                                                                                                             



##----- put your code here
$dir = getcwd;
$configfile = $dir . "/config";
open(CONFIG, "+<$configfile");
while (<CONFIG>)
{
        chomp;
        s/#.*//;
        s/^\s+//;
        s/\s+$//;
        ($var, $value) = split(/\s*=\s*/, $_, 2);
        $Variables{$var} = ${value};
}
#print "Content-type: text/html\r\n\r\n";
$webserver = $Variables{"WEBSERVER"};

$Variables{"OS"} = $^O;
 $sqlserver = $Variables{"MYSQLSERVER"};
        $username = $Variables{"MYSQLUSER"};
        $password = $Variables{"MYSQLPASS"};
        $port = $Variables{"MYSQLPORT"};
        $dbh = DBI->connect("dbi:mysql:database=framework;host=$sqlserver;port=$port", $username,$password);
	$selectquery = "SELECT path from agents where number=" . $agent;
			$sql = $dbh->prepare($selectquery);
			$results = $sql->execute;
			@rows = $sql->fetchrow_array();
			$path = @rows[0];
$selectquery = "SELECT controlkey from agents where number=" . $agent;
			$sql = $dbh->prepare($selectquery);
			$results = $sql->execute;
			@rows = $sql->fetchrow_array();
			$key = @rows[0];
if ($delivery eq "HTTP")
{
			$command = $key . " PICT HTTP\n";
			$control = $webserver . $path . "/putfunc";
			open(CONTROLFILE, ">$control");
       		        print CONTROLFILE $command;
        		close(CONTROLFILE);
		}
		if ($delivery eq "SMS")
		{
$selectquery = "SELECT id from modems where number=" . $modemNo;
			$sql = $dbh->prepare($selectquery);
			$results = $sql->execute;
			@rows = $sql->fetchrow_array();
			$modem = @rows[0];
			
			$command = $key . " PICT HTTP " . $modem . "\n";
                        $control = $webserver . $path . "/putfunc";
                        open(CONTROLFILE, ">$control");
                        print CONTROLFILE $command;
                        close(CONTROLFILE);

}

##----- end of your code

my $url = "menu.pl";
print "Location: $url\n\n";

