#!/usr/bin/perl
BEGIN { use CGI::Carp qw(fatalsToBrowser); };
use DBI;
use Cwd;
use FindBin qw($Bin);
use lib "$Bin/lib";
use SPF;
use CGI ':cgi-lib';

my %FORM = Vars();
$agent = $FORM{"agentsDD"};
$delivery = $FORM{"deliveryMethodRB"};
$modemNo = $FORM{"modemNoDD"};
                                                                                                                                                                             



##----- put your code here
my %Variables = SPF::readconfig();
my $dbh = SPF::dbconnect(%Variables);
#print "Content-type: text/html\r\n\r\n";
$webserver = $Variables{"WEBSERVER"};

$Variables{"OS"} = $^O;
			$sql = $dbh->prepare("SELECT path from agents where number=?");
			$results = $sql->execute($agent);
			@rows = $sql->fetchrow_array();
			$path = @rows[0];
			$sql = $dbh->prepare("SELECT controlkey from agents where number=?");
			$results = $sql->execute($agent);
			@rows = $sql->fetchrow_array();
			$key = @rows[0];
if ($delivery eq "HTTP")
{
			$command = $key . " PICT HTTP\n";
			$control = $webserver . $path . "/putfunc";
			open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
       		        print CONTROLFILE $command;
        		close(CONTROLFILE);
		}
		if ($delivery eq "SMS")
		{
			$sql = $dbh->prepare("SELECT id from modems where number=?");
			$results = $sql->execute($modemNo);
			@rows = $sql->fetchrow_array();
			$modem = @rows[0];
			
			$command = $key . " PICT HTTP " . $modem . "\n";
                        $control = $webserver . $path . "/putfunc";
                        open(CONTROLFILE, ">",$control) or die "Couldn't open $control for writing! ($!)";
                        print CONTROLFILE $command;
                        close(CONTROLFILE);

}

##----- end of your code

my $url = "menu.pl";
print "Location: $url\n\n";

