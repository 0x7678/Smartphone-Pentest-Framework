#!/usr/bin/perl
BEGIN { use CGI::Carp qw(fatalsToBrowser); };
use Cwd;
use DBI;
use FindBin qw($Bin);
use lib "$Bin/lib";
use SPF;
use CGI ':cgi-lib';

my %FORM = Vars();
$number = $FORM{"modemPhoneNo"};
$key = $FORM{"controlKey"};
$path = $FORM{"appURLPath"};


##----- put your code here
my %Variables = SPF::readconfig();
my $dbh = SPF::dbconnect(%Variables);
$Variables{"OS"} = $^O;
#print "Content-type: text/html\r\n\r\n";
#print "Connect Smartphone App";
	$webserver = $Variables{WEBSERVER};
        $fullpath = $webserver. $path;
        $type = "app";
        $number2 = "\"" . $number . "\"";
        $path2 = "\"" . $path . "\"";
        $key2 = "\"" . $key . "\"";
        $type2 = "\"" . $type . "\"";
	$command1 = "mkdir " . $fullpath;
	system($command1);
	$connectfile = $fullpath . "/connect";
	$command2 = "touch " . $connectfile;
	system($command2);
	$command3 = "chmod 777 " . $connectfile;
	system($command3);
	$picturefile = $fullpath . "/picture.jpg";
	$command4 = "touch " . $picturefile;
	system($command4);
	$command5 = "chmod 777 " . $picturefile;
	system($command5);
	$textfile = $fullpath . "/text.txt";
        $command6 = "touch " . $textfile;
        system($command6);
        $command7 = "chmod 777 " . $textfile;
        system($command7);
	$textfile2 = $fullpath . "/text2.txt";
	$command77 = "touch ". $textfile2;
	system($command77);
	$command7777 = "chmod 777 " . $textfile2;
        system($command7777);
	$pictureupload = $fullpath . "/pictureupload.php";
        $command8 = "touch " . $pictureupload;
        system($command8);
        $command9 = "chmod 777 " . $pictureupload;
        system($command9);
	$pictureuploadtext = "<?php\n\$base=\$_REQUEST['picture'];\necho \$base;\n\$binary=base64_decode(\$base);\nheader('Content-Type: bitmap; charset=utf-8');\n\$file = fopen('picture.jpg', 'wb');\nfwrite(\$file, \$binary);\nfclose(\$file);\n?>";
	open(PICFILE, ">",$pictureupload) or die "Couldn't open $pictureupload for writing! ($!)";
	print PICFILE $pictureuploadtext;
	close(PICFILE);
	$textupload = $fullpath . "/textuploader.php";
        $command10 = "touch " . $textupload;
        system($command10);
        $command11 = "chmod 777 " . $textupload;
        system($command11);
        $textuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('text.txt', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(TEXTFILE, ">",$textupload) or die "Couldn't open $textupload for writing! ($!)";
        print TEXTFILE $textuploadtext;
        close(TEXTFILE);
	$text2upload = $fullpath . "/text2uploader.php";
        $command100 = "touch " . $text2upload;
        system($command100);
        $command110 = "chmod 777 " . $text2upload;
        system($command110);
	$text2uploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('text2.txt', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(TEXT2FILE, ">",$text2upload) or die "Couldn't open $text2upload for writing! ($!)";
        print TEXT2FILE $text2uploadtext;
        close(TEXT2FILE);
	$connectupload = $fullpath . "/connectuploader.php";
        $command12 = "touch " . $connectupload;
        system($command12);
        $command13 = "chmod 777 " . $connectupload;
        system($command13);
        $connectuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('connect','wb');\nfwrite(\$file, \$base);\n?>";
        open(CONNECTFILE, ">",$connectupload) or die "Couldn't open $connectupload for writing! ($!)";
        print CONNECTFILE $connectuploadtext;
        close(CONNECTFILE);
	$getfuncfile = $fullpath . "/getfunc";
        $command6 = "touch " . $getfuncfile;
        system($command6);
        $command7 = "chmod 777 " . $getfuncfile;
        system($command7);
	$putfuncfile = $fullpath . "/putfunc";
        $command6 = "touch " . $putfuncfile;
        system($command6);
        $command7 = "chmod 777 " . $putfuncfile;
        system($command7);
	$getfuncupload = $fullpath . "/getfuncuploader.php";
        $command10 = "touch " . $getfuncupload;
        system($command10);
        $command11 = "chmod 777 " . $getfuncupload;
        system($command11);
        $getfuncuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('getfunc', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(GETFUNCUPLOADFILE, ">",$getfuncupload) or die "Couldn't open $getfuncupload for writing! ($!)";
        print GETFUNCUPLOADFILE $getfuncuploadtext;
        close(GETFUNCUPLOADFILE);
	 $putfuncupload = $fullpath . "/putfuncuploader.php";
        $command10 = "touch " . $putfuncupload;
        system($command10);
        $command11 = "chmod 777 " . $putfuncupload;
        system($command11);
        $putfuncuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('putfunc', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(PUTFUNCUPLOADFILE, ">",$putfuncupload) or die "Couldn't open $putfuncupload for writing! ($!)";
        print PUTFUNCUPLOADFILE $putfuncuploadtext;
        close(PUTFUNCUPLOADFILE);
	while(1){
		 $fullpath1 = $webserver. $path . "/connect";
                open(CONNECTFILE, "+<",$fullpath1) or die "Couldn't open $fullpath1 for reading! ($!)";
;
                $line= <CONNECTFILE>;
                $correctstring = $key . " CONNECT";
                if ($line eq $correctstring)
                {
                        $command = "\n" . $key . " CONNECTED";
                        print CONNECTFILE $command;
                        close(CONNECTFILE);
                       # print "CONNECTED!\n";
                        last;
                }
                else {
                         close(CONNECTFILE);
                #       sleep(1);
                }
	}
	$modemtype = "app";
        $sql = $dbh->prepare("INSERT INTO modems (id,number,path,controlkey,type) VALUES (DEFAULT,?,?,?,?)");
	$sql->execute($number,$path,$key,$modemtype);
	@exec = (qw(perl poller.pl),$path,$key);
			$pid = fork;
			die "fork failed" unless defined $pid;
			if ($pid ==0)
			{
			open STDIN,'<','/dev/null';
			open STDOUT,'<','/dev/null';
			open STDERR,'>&STDOUT';
			exec {$exec[0]} @exec;
			}



##----- end of your code

my $url = "menu.pl";
print "Location: $url\n\n";
