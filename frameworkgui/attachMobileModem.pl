#!/usr/bin/perl
use Cwd;
use DBI;
# Read the standard input (sent by the form):
read(STDIN, $FormData, $ENV{'CONTENT_LENGTH'});
# Get the name and value for each form input:
@pairs = split(/&/, $FormData);
# Then for each name/value pair....
foreach $pair (@pairs) {
	# Separate the name and value:
	($name, $value) = split(/=/, $pair);
	# Convert + signs to spaces:
	$value =~ tr/+/ /;
	# Convert hex pairs (%HH) to ASCII characters:
	$value =~ s/%([a-fA-F0-9][a-fA-F0-9])/pack("C", hex($1))/eg;
	# Store values in a hash called %FORM:
	$FORM{$name} = $value;
}


$number = $FORM{"modemPhoneNo"};
$key = $FORM{"controlKey"};
$path = $FORM{"appURLPath"};


##----- put your code here
$dir = getcwd;
$configfile = $dir . "/config";
open(CONFIG, "+<$configfile");
while (<CONFIG>)
{
        chomp;
        s/#.*//;
        s/^\s+//;
        s/\s+$//;
        ($var, $value) = split(/\s*=\s*/, $_, 2);
        $Variables{$var} = ${value};
}
$Variables{"OS"} = $^O;
#print "Content-type: text/html\r\n\r\n";
#print "Connect Smartphone App";
	$webserver = $Variables{WEBSERVER};
        $fullpath = $webserver. $path;
        $type = "app";
        $number2 = "\"" . $number . "\"";
        $path2 = "\"" . $path . "\"";
        $key2 = "\"" . $key . "\"";
        $type2 = "\"" . $type . "\"";
	$command1 = "mkdir " . $fullpath;
	system($command1);
	$connectfile = $fullpath . "/connect";
	$command2 = "touch " . $connectfile;
	system($command2);
	$command3 = "chmod 777 " . $connectfile;
	system($command3);
	$picturefile = $fullpath . "/picture.jpg";
	$command4 = "touch " . $picturefile;
	system($command4);
	$command5 = "chmod 777 " . $picturefile;
	system($command5);
	$textfile = $fullpath . "/text.txt";
        $command6 = "touch " . $textfile;
        system($command6);
        $command7 = "chmod 777 " . $textfile;
        system($command7);
	$textfile2 = $fullpath . "/text2.txt";
	$command77 = "touch ". $textfile2;
	system($command77);
	$command7777 = "chmod 777 " . $textfile2;
        system($command7777);
	$pictureupload = $fullpath . "/pictureupload.php";
        $command8 = "touch " . $pictureupload;
        system($command8);
        $command9 = "chmod 777 " . $pictureupload;
        system($command9);
	$pictureuploadtext = "<?php\n\$base=\$_REQUEST['picture'];\necho \$base;\n\$binary=base64_decode(\$base);\nheader('Content-Type: bitmap; charset=utf-8');\n\$file = fopen('picture.jpg', 'wb');\nfwrite(\$file, \$binary);\nfclose(\$file);\n?>";
	open(PICFILE, ">$pictureupload");
	print PICFILE $pictureuploadtext;
	close(PICFILE);
	$textupload = $fullpath . "/textuploader.php";
        $command10 = "touch " . $textupload;
        system($command10);
        $command11 = "chmod 777 " . $textupload;
        system($command11);
        $textuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('text.txt', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(TEXTFILE, ">$textupload");
        print TEXTFILE $textuploadtext;
        close(TEXTFILE);
	$text2upload = $fullpath . "/text2uploader.php";
        $command100 = "touch " . $text2upload;
        system($command100);
        $command110 = "chmod 777 " . $text2upload;
        system($command110);
	$text2uploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('text2.txt', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(TEXT2FILE, ">$text2upload");
        print TEXT2FILE $text2uploadtext;
        close(TEXT2FILE);
	$connectupload = $fullpath . "/connectuploader.php";
        $command12 = "touch " . $connectupload;
        system($command12);
        $command13 = "chmod 777 " . $connectupload;
        system($command13);
        $connectuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('connect','wb');\nfwrite(\$file, \$base);\n?>";
        open(CONNECTFILE, ">$connectupload");
        print CONNECTFILE $connectuploadtext;
        close(CONNECTFILE);
	$getfuncfile = $fullpath . "/getfunc";
        $command6 = "touch " . $getfuncfile;
        system($command6);
        $command7 = "chmod 777 " . $getfuncfile;
        system($command7);
	$putfuncfile = $fullpath . "/putfunc";
        $command6 = "touch " . $putfuncfile;
        system($command6);
        $command7 = "chmod 777 " . $putfuncfile;
        system($command7);
	$getfuncupload = $fullpath . "/getfuncuploader.php";
        $command10 = "touch " . $getfuncupload;
        system($command10);
        $command11 = "chmod 777 " . $getfuncupload;
        system($command11);
        $getfuncuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('getfunc', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(GETFUNCUPLOADFILE, ">$getfuncupload");
        print GETFUNCUPLOADFILE $getfuncuploadtext;
        close(GETFUNCUPLOADFILE);
	 $putfuncupload = $fullpath . "/putfuncuploader.php";
        $command10 = "touch " . $putfuncupload;
        system($command10);
        $command11 = "chmod 777 " . $putfuncupload;
        system($command11);
        $putfuncuploadtext = "<?php\n\$base=\$_REQUEST['text'];\nheader('Content-Type: text; charset=utf-8');\n\$file = fopen('putfunc', 'wb');\nfwrite(\$file, \$base);\n?>";
        open(PUTFUNCUPLOADFILE, ">$putfuncupload");
        print PUTFUNCUPLOADFILE $putfuncuploadtext;
        close(PUTFUNCUPLOADFILE);
	while(1){
		 $fullpath1 = $webserver. $path . "/connect";
                open(CONNECTFILE, "+<$fullpath1");
                $line= <CONNECTFILE>;
                $correctstring = $key . " CONNECT";
                if ($line eq $correctstring)
                {
                        $command = "\n" . $key . " CONNECTED";
                        print CONNECTFILE $command;
                        close(CONNECTFILE);
                       # print "CONNECTED!\n";
                        last;
                }
                else {
                         close(CONNECTFILE);
                #       sleep(1);
                }
	}
 	$table = "modems";
        $sqlserver = $Variables{"MYSQLSERVER"};
        $username = $Variables{"MYSQLUSER"};
        $password = $Variables{"MYSQLPASS"};
        $port = $Variables{"MYSQLPORT"};
        $dbh = DBI->connect("dbi:mysql:database=framework;host=$sqlserver;port=$port", $username,$password); 
        $type = "app";
	$number2 = "\"" . $number . "\"";
        $path2 = "\"" . $path . "\"";
        $key2 = "\"" . $key . "\""; 
        $type2 = "\"" . $type . "\"";
        $insertquery = "INSERT INTO $table (id,number,path,controlkey,type) VALUES (DEFAULT,$number2,$path2,$key2, $type2)";
        $sql = $dbh->prepare($insertquery);
	$sql->execute;
	$startcommand = "perl poller.pl " . $path . " " . $key; 
			$pid = fork;
			die "fork failed" unless defined $pid;
			if ($pid ==0)
			{
			system($startcommand);
			}



##----- end of your code

my $url = "menu.pl";
print "Location: $url\n\n";
