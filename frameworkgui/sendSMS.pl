#!/usr/bin/perl
BEGIN { use CGI::Carp qw(fatalsToBrowser); };
use DBI;
use Cwd;
use FindBin qw($Bin);
use lib "$Bin/lib";
use SPF;
use CGI ':cgi-lib';

my %FORM = Vars();
$agent = $FORM{"agentsDD"};
$deliverymethod = $FORM{"deliveryMethodRB"};
$sendmessage = $FORM{"messageTB"};
$sendnumber = $FORM{"recipient"};
$modemNo = $FORM{"modemNoDD"};
                                                                                                                                                                             



##----- put your code here
my %Variables = SPF::readconfig();
my $dbh = SPF::dbconnect(%Variables);
#print "Content-type: text/html\r\n\r\n";
$webserver = $Variables{"WEBSERVER"};

$Variables{"OS"} = $^O;
			$sql = $dbh->prepare("SELECT path from agents where number=?");
			$results = $sql->execute($agent);
			@rows = $sql->fetchrow_array();
			$path = @rows[0];

			$sql = $dbh->prepare("SELECT controlkey from agents where number=?");
			$results = $sql->execute($agent);
			@rows = $sql->fetchrow_array();
			$key = @rows[0];
if ($deliverymethod eq "HTTP")
		{

		$command = $key . " " . "SPAM" . " " . "none" . " " . $deliverymethod . " " . $sendnumber . " " . $sendmessage . "\n";
			$control = $webserver . $path . "/putfunc";
			open(CONTROLFILE, ">>",$control) or die "Couldn't open $control for appending! ($!)";
       		        print CONTROLFILE $command;
                        close(CONTROLFILE);

		}
		if ($deliverymethod eq "SMS")
		{
			$sql = $dbh->prepare("SELECT id from modems where number=?");
			$results = $sql->execute($modemNo);
			@rows = $sql->fetchrow_array();
			$modem = @rows[0];

				$command = $key . " " . "SPAM" . " " . $modem  . " " . $deliverymethod . " " . $sendnumber . " " . $sendmessage . "\n";
                        	$control = $webserver . $path . "/putfunc";
                        	open(CONTROLFILE, ">>",$control) or die "Couldn't open $control for appending! ($!)";
                        	print CONTROLFILE $command;
                        	close(CONTROLFILE);
}


##----- end of your code

my $url = "menu.pl";
print "Location: $url\n\n";

