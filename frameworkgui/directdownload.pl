#!/usr/bin/perl
use Cwd;
use DBI;
$dir = getcwd;
$configfile = $dir . "/config";
open(CONFIG, "+<$configfile");
while (<CONFIG>)
{
        chomp;
        s/#.*//;
        s/^\s+//;
        s/\s+$//;
        ($var, $value) = split(/\s*=\s*/, $_, 2);
        $Variables{$var} = ${value};
}
$webserver = $Variables{"WEBSERVER"};
        $sqlserver = $Variables{"MYSQLSERVER"};
        $ipaddress = $Variables{"IPADDRESS"};
$path = $ARGV[0];
	$filename = $ARGV[1];
	$number = $ARGV[2];
$platform = $ARGV[3];
$modem = $ARGV[4];
chomp($platform);
if ($platform eq "android")
{
$link = "http://" . $ipaddress . $path . $filename;
			 $fullpath = $webserver. $path;
		        $command1 = "mkdir " . $fullpath;
        		system($command1);
			$location = $Variables{"ANDROIDAGENT"};
			
			$command = "cp " . $location . " " . $webserver . $path . $filename;
			system($command);
			  
                       
                		$username = $Variables{"MYSQLUSER"};
                		$password = $Variables{"MYSQLPASS"};
                		$port = $Variables{"MYSQLPORT"};
$dbh = DBI->connect("dbi:mysql:database=framework;host=$sqlserver;port=$port", $username,$password);
			 	$pathquery = "SELECT path from modems where id=" . $modem;
                          	$sql = $dbh->prepare($pathquery);
                                $results = $sql->execute;
                                @rows = $sql->fetchrow_array();
                                $path2 = @rows[0];
			 	$keyquery = "SELECT controlkey from modems where id=" . $modem;
                                $sql = $dbh->prepare($keyquery);
                                $results2 = $sql->execute;
                                @rows = $sql->fetchrow_array();
                                $key2 = @rows[0];
				 $control = $webserver . $path2 . "/getfunc";
                        	open(CONTROLFILE, ">$control");
				$command2 = $key2 . " " . "SEND" . " " . $number . " " . "This is a cool app: " . $link;
                        	print CONTROLFILE $command2;
                       		close(CONTROLFILE);
}
